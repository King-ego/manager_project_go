name: CI merge
on:
  push:
    branches: [main]
  pull_request:
jobs:
  docker:
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Copiar .env.example to .env
        run: cp .env.example .env

      - name: ğŸ³ Subir Docker Compose
        run: docker compose -f docker-compose.yml up -d --build

      - name: ğŸ•’ Aguardar serviÃ§os subirem
        run: |
            echo "Aguardando Postgres e Redis..."
            sleep 20

      - name: ğŸ“‹ Verificar containers ativos
        run: docker ps

      - name: ğŸ” Testar rota /health
        run: |
          echo "Testando rota /health..."
          for i in {1..10}; do
            if curl -s http://localhost:8989/health | grep -q "healthy"; then
              echo "âœ… ServiÃ§o respondeu saudÃ¡vel!"
              exit 0
            fi
            echo "Aguardando serviÃ§o iniciar..."
            sleep 10
          done
          echo "âŒ ServiÃ§o nÃ£o respondeu a tempo."
          exit 1
