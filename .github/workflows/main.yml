name: CI Docker Build
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  docker:
    name: CI Docker Build
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Copiar .env.example to .env
        run: cp .env.example .env

      - name: üê≥ Subir Docker Compose
        run: docker compose -f docker-compose.yml up -d --build

      - name: üïí Aguardar servi√ßos subirem
        run: |
          echo "Aguardando Postgres e Redis..."
          sleep 20

      - name: üìã Verificar containers ativos
        run: docker ps

      - name: Install PostgreSQL client
        run: sudo apt-get install -y postgresql-client

      - name: üîç Testar rota /health
        run: |
          echo "Aguardando inicializa√ß√£o dos servi√ßos..."
          sleep 30

          echo "Testando rota /health..."
          for i in {1..10}; do
            if curl -s http://localhost:8989/health | grep -q "healthy"; then
              echo "‚úÖ Servi√ßo respondeu saud√°vel!"
              exit 0
            fi
            echo "Tentativa $i/10 - Aguardando servi√ßo iniciar..."
            sleep 10
          done
          echo "‚ùå Servi√ßo n√£o respondeu a tempo."

          echo "=== LOGS DO BANCO ==="
          docker compose logs manager_db
          echo "=== LOGS DA APLICA√á√ÉO ==="
          docker compose logs manager_project
          exit 1